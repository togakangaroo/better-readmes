{% extends "base.html" %}

{% block title %}{{ todo_list.name }} - Todo App{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>{{ todo_list.name }}</h1>
        <small class="text-muted">Created {{ todo_list.created_at.strftime('%B %d, %Y') }}</small>
    </div>
    <div>
        <a href="{{ url_for('add_item', list_id=todo_list.id) }}" class="btn btn-primary">Add Item</a>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Back to Lists</a>
        {% if todo_list.can_be_deleted %}
            <form method="POST" action="{{ url_for('delete_list', list_id=todo_list.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-outline-danger" 
                        onclick="return confirm('Are you sure you want to delete this list?')">Delete List</button>
            </form>
        {% endif %}
    </div>
</div>

{% if todo_list.items %}
    <div class="row">
        {% for status in ['TODO', 'IN_PROGRESS', 'DONE'] %}
            <div class="col-md-4">
                <h4>
                    {% if status == 'TODO' %}
                        <span class="badge bg-secondary">TODO</span>
                    {% elif status == 'IN_PROGRESS' %}
                        <span class="badge bg-warning">IN PROGRESS</span>
                    {% else %}
                        <span class="badge bg-success">DONE</span>
                    {% endif %}
                </h4>
                
                {% for item in todo_list.items %}
                    {% if item.status == status %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">{{ item.title }}</h6>
                            <small class="text-muted">Created {{ item.created_at.strftime('%m/%d/%Y %I:%M %p') }}</small>
                            
                            {% if item.status_changes|length > 1 %}
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#history-{{ item.id }}">
                                        View History
                                    </button>
                                    <div class="collapse mt-2" id="history-{{ item.id }}">
                                        <div class="card card-body">
                                            <h6>Status History:</h6>
                                            {% for change in item.status_changes|reverse %}
                                                <small class="d-block">
                                                    {{ change.timestamp.strftime('%m/%d/%Y %I:%M %p') }}: 
                                                    {% if change.old_status %}
                                                        {{ change.old_status }} â†’ {{ change.new_status }}
                                                    {% else %}
                                                        Created as {{ change.new_status }}
                                                    {% endif %}
                                                </small>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            
                            <div class="mt-2">
                                <!-- Inline status change dropdown -->
                                <form method="POST" action="{{ url_for('change_status', item_id=item.id) }}" class="d-inline me-2">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <select name="status" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
                                        <option value="TODO" {% if item.status == 'TODO' %}selected{% endif %}>TODO</option>
                                        <option value="IN_PROGRESS" {% if item.status == 'IN_PROGRESS' %}selected{% endif %}>IN PROGRESS</option>
                                        <option value="DONE" {% if item.status == 'DONE' %}selected{% endif %}>DONE</option>
                                    </select>
                                </form>
                                
                                <a href="{{ url_for('edit_item', item_id=item.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                                <form method="POST" action="{{ url_for('delete_item', item_id=item.id) }}" class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-sm btn-outline-danger" 
                                            onclick="return confirm('Are you sure you want to delete this item?')">Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
                
                {% set has_items = false %}
                {% for item in todo_list.items %}
                    {% if item.status == status %}
                        {% set has_items = true %}
                    {% endif %}
                {% endfor %}
                {% if not has_items %}
                    <p class="text-muted">No items</p>
                {% endif %}
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center">
        <p class="lead">No items in this list yet.</p>
        <a href="{{ url_for('add_item', list_id=todo_list.id) }}" class="btn btn-primary">Add Your First Item</a>
    </div>
{% endif %}
{% endblock %}
