{% extends "base.html" %}

{% block title %}Todo Lists{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>My Todo Lists</h1>
    <a href="{{ url_for('create_list') }}" class="btn btn-primary">Create New List</a>
</div>

{% if lists %}
    <!-- Status Overview Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">ðŸ“Š Overall Status Overview</h5>
                    {% set all_items = [] %}
                    {% for list in lists %}
                        {% for item in list.items %}
                            {% set _ = all_items.append(item) %}
                        {% endfor %}
                    {% endfor %}
                    {% set total_items = all_items|length %}
                    {% set todo_items = all_items|selectattr('status', 'equalto', 'TODO')|list %}
                    {% set in_progress_items = all_items|selectattr('status', 'equalto', 'IN_PROGRESS')|list %}
                    {% set done_items = all_items|selectattr('status', 'equalto', 'DONE')|list %}
                    {% set total_todo = todo_items|length %}
                    {% set total_in_progress = in_progress_items|length %}
                    {% set total_done = done_items|length %}
                    
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h2 class="text-primary">{{ total_items }}</h2>
                                    <p class="card-text">Total Items</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-secondary text-white">
                                <div class="card-body">
                                    <h2>{{ total_todo }}</h2>
                                    <p class="card-text">TODO</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h2>{{ total_in_progress }}</h2>
                                    <p class="card-text">IN PROGRESS</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h2>{{ total_done }}</h2>
                                    <p class="card-text">DONE</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if total_items > 0 %}
                        <div class="mt-3">
                            <div class="progress">
                                <div class="progress-bar bg-secondary" role="progressbar" 
                                     style="width: {{ (total_todo / total_items * 100)|round(1) }}%">
                                </div>
                                <div class="progress-bar bg-warning" role="progressbar" 
                                     style="width: {{ (total_in_progress / total_items * 100)|round(1) }}%">
                                </div>
                                <div class="progress-bar bg-success" role="progressbar" 
                                     style="width: {{ (total_done / total_items * 100)|round(1) }}%">
                                </div>
                            </div>
                            <small class="text-muted">
                                Progress: {{ ((total_done / total_items) * 100)|round(1) }}% complete
                            </small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endif %}

{% if lists %}
    <div class="row">
        {% for list in lists %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{{ list.name }}</h5>
                        <p class="card-text">
                            <small class="text-muted">
                                {{ list.items|length }} item{{ 's' if list.items|length != 1 else '' }}
                                {% if list.items %}
                                    <br>
                                    {% set list_todo_items = list.items|selectattr('status', 'equalto', 'TODO')|list %}
                                    {% set list_in_progress_items = list.items|selectattr('status', 'equalto', 'IN_PROGRESS')|list %}
                                    {% set list_done_items = list.items|selectattr('status', 'equalto', 'DONE')|list %}
                                    {% set todo_count = list_todo_items|length %}
                                    {% set in_progress_count = list_in_progress_items|length %}
                                    {% set done_count = list_done_items|length %}
                                    
                                    <span class="badge bg-secondary">{{ todo_count }} TODO</span>
                                    <span class="badge bg-warning">{{ in_progress_count }} IN PROGRESS</span>
                                    <span class="badge bg-success">{{ done_count }} DONE</span>
                                {% endif %}
                            </small>
                        </p>
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('list_detail', list_id=list.id) }}" class="btn btn-outline-primary btn-sm">View</a>
                            {% if list.can_be_deleted %}
                                <form method="POST" action="{{ url_for('delete_list', list_id=list.id) }}" class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <button type="submit" class="btn btn-outline-danger btn-sm" 
                                            onclick="return confirm('Are you sure you want to delete this list?')">Delete</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center">
        <p class="lead">No todo lists yet.</p>
        <a href="{{ url_for('create_list') }}" class="btn btn-primary">Create Your First List</a>
    </div>
{% endif %}
{% endblock %}
